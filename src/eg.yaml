device:
  name: eg
  version: 1.0

platforms:
  - platform: plugins.mqtt
    id: mqtt
    variables:
      base_topic: "home/{{id(device).configuration.name}}"
    host: home
    port: 1883
    availability:
      topic: "{{id(mqtt).variables.base_topic}}/connected"
      payload_on: "yes"
      payload_off: "no"
    on_connected:
      - actions:
        - action: print
          values:
            payload: "on_connected: {{id(mqtt).variables.base_topic}}"
    on_disconnected:
      - actions:
        - action: print
          values:
            payload: bye    
    on_message:
      - actions:
        - action: print #display all messages in the dashboard
          values:
            payload: "I got a message on topic '{{topic}}' with payload: {{payload}}"  
        - action: webTable

  - platform: plugins.gpio
    id: gpio
    factory: rpigpio

  - platform: plugins.console
    id: console

  - platform: plugins.dfplayer
    id: dfplayer
    tx_pin: GPIO5

  - platform: plugins.hass
    id: hass
    connection: mqtt
    exports:
      - id: player
        type: switch
        icon: mdi:home
        on_command: 
          - actions:
            - action: player
              values:
                command: next_track
        off_command: 
          - actions:
            - action: player
              values:
                topic: pause
        expose_state: state.is_playing
      - id: button1
        type: sensor
        on_event: on_press
        off_event: on_release
        expose_state: state.is_pressed

#  - platform: plugins.web
#    id: web

actions:
  - id: print
    platform: console
    type: PrintAction

  - id: player
    platform: dfplayer

  - id: led
    platform: gpio
    pin: GPIO13
    type: BinaryAction

  - id: webTable
    platform: web
    type: UpdateAction

sensors:
  - id: button1
    platform: gpio
    pin: GPIO6
    type: ButtonSensor
    debug: True
    check_state_delay: 0.03
    on_press:
      - actions:
        - action: print
          values: 
            payload: button high
        - action: led
          values:
            topic: toggle
    on_release:
      - actions:
        - action: print
          values: 
            payload: button low
        #- action: led
        #  values:
        #    topic: turn_off            
    on_hold:
      - actions:
        - action: print
          values: 
            payload: GPIO6 hold
        - action: player
          values:
            command: next_track        


  - id: play
    platform: mqtt
    topic: "{{id(mqtt).variables.base_topic}}/play"
    on_message:
      - actions:
        - action: print
          values:
            payload: "I got a message on topic '{{topic}}' with payload: {{payload}}"  
        - action: player
          values:
            command: next_track 


  - id: something
    platform: mqtt
    topic: "{{id(mqtt).variables.base_topic}}/x"
    on_message:
      - conditions:
          - actual: "{{id(mqtt).is_connected}}"
            comperator: equals
            expected: True
        actions:
        - action: print
          values:
            payload: "I got a message and {{id(mqtt).is_connected}} == true"      

      - actions:
        - action: print
          values:
            payload: "Got message on topic '{{topic}}', with payload '{{payload}}'"


        
